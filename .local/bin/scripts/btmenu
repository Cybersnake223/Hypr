#!/bin/bash

############################################################################################################
##   ______  __      __  _______   ________  _______    ______   __    __   ______   __    __  ________   ##
##  /      \|  \    /  \|       \ |        \|       \  /      \ |  \  |  \ /      \ |  \  /  \|        \  ##
## |  $$$$$$\\$$\  /  $$| $$$$$$$\| $$$$$$$$| $$$$$$$\|  $$$$$$\| $$\ | $$|  $$$$$$\| $$ /  $$| $$$$$$$$  ##
## | $$   \$$ \$$\/  $$ | $$__/ $$| $$__    | $$__| $$| $$___\$$| $$$\| $$| $$__| $$| $$/  $$ | $$__      ##
## | $$        \$$  $$  | $$    $$| $$  \   | $$    $$ \$$    \ | $$$$\ $$| $$    $$| $$  $$  | $$  \     ##
## | $$   __    \$$$$   | $$$$$$$\| $$$$$   | $$$$$$$\ _\$$$$$$\| $$\$$ $$| $$$$$$$$| $$$$$\  | $$$$$     ##
## | $$__/  \   | $$    | $$__/ $$| $$_____ | $$  | $$|  \__| $$| $$ \$$$$| $$  | $$| $$ \$$\ | $$_____   ##
##  \$$    $$   | $$    | $$    $$| $$     \| $$  | $$ \$$    $$| $$  \$$$| $$  | $$| $$  \$$\| $$     \  ##
##   \$$$$$$     \$$     \$$$$$$$  \$$$$$$$$ \$$   \$$  \$$$$$$  \$$   \$$ \$$   \$$ \$$   \$$ \$$$$$$$$  ##
##                                                                                                        ##
## Bluetooth Script                                                                                       ##
## Created by Cybersnake                                                                                  ##
############################################################################################################

rfkill unblock bluetooth
bluetoothctl power on

get_device_info() {
    # Get list, skipping the "Added devices:" header
    local devices=$(bt-device -l | tail -n +2)
    
    if [ -z "$devices" ]; then
        notify-send "Bluetooth" "No paired devices found."
        exit 1
    fi

    # Pick the device using Rofi
    # This shows the full line (Name + MAC) to the user
    local chosen=$(echo "$devices" | rofi -dmenu -i -p "Bluetooth Toggle" -l 5)
    
    # Exit if user hits Escape
    [ -z "$chosen" ] && exit 0

    # Extract MAC (inside parentheses) and Name (before parentheses)
    MAC=$(echo "$chosen" | sed 's/.*(\(.*\))/\1/')
    DEV_NAME=$(echo "$chosen" | sed 's/ (.*)//')
}

get_device_info

# Get the specific 'Connected' status
is_connected=$(bt-device -i "$MAC" | grep "Connected:" | awk '{print $2}')

# Toggle Logic
if [ "$is_connected" = "1" ] || [ "$is_connected" = "yes" ]; then
    notify-send "Bluetooth" "Disconnecting from $DEV_NAME..."
    bluetoothctl disconnect "$MAC" > /dev/null 2>&1
else
    notify-send "Bluetooth" "Connecting to $DEV_NAME..."
    
    # Run the connect command and immediately check if it succeeded (exit code 0)
    if bluetoothctl connect "$MAC" > /dev/null 2>&1; then
        notify-send "Bluetooth" "Connected to $DEV_NAME"
    else
        # Small delay: sometimes BlueZ is slow to update status
        sleep 1
        # Double check status before complaining
        check=$(bt-device -i "$MAC" | grep "Connected:" | awk '{print $2}')
        if [ "$check" = "1" ] || [ "$check" = "yes" ]; then
            notify-send "Bluetooth" "Connected to $DEV_NAME"
        else
            notify-send "Bluetooth" "Failed to connect to $DEV_NAME"
        fi
    fi
fi
